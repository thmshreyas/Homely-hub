{"version":3,"file":"createServerValidate.cjs","sources":["../../../src/nextjs/createServerValidate.ts"],"sourcesContent":["import { decode } from 'decode-formdata'\nimport {\n  isGlobalFormValidationError,\n  isStandardSchemaValidator,\n  standardSchemaValidators,\n} from '@tanstack/form-core'\nimport { ServerValidateError } from './error'\nimport type {\n  FormAsyncValidateOrFn,\n  FormOptions,\n  FormValidateAsyncFn,\n  FormValidateOrFn,\n  UnwrapFormAsyncValidateOrFn,\n} from '@tanstack/form-core'\nimport type { ServerFormState } from './types'\n\ninterface CreateServerValidateOptions<\n  TFormData,\n  TOnMount extends undefined | FormValidateOrFn<TFormData>,\n  TOnChange extends undefined | FormValidateOrFn<TFormData>,\n  TOnChangeAsync extends undefined | FormAsyncValidateOrFn<TFormData>,\n  TOnBlur extends undefined | FormValidateOrFn<TFormData>,\n  TOnBlurAsync extends undefined | FormAsyncValidateOrFn<TFormData>,\n  TOnSubmit extends undefined | FormValidateOrFn<TFormData>,\n  TOnSubmitAsync extends undefined | FormAsyncValidateOrFn<TFormData>,\n  TOnDynamic extends undefined | FormValidateOrFn<TFormData>,\n  TOnDynamicAsync extends undefined | FormAsyncValidateOrFn<TFormData>,\n  TOnServer extends undefined | FormAsyncValidateOrFn<TFormData>,\n  TSubmitMeta,\n> extends FormOptions<\n    TFormData,\n    TOnMount,\n    TOnChange,\n    TOnChangeAsync,\n    TOnBlur,\n    TOnBlurAsync,\n    TOnSubmit,\n    TOnSubmitAsync,\n    TOnDynamic,\n    TOnDynamicAsync,\n    TOnServer,\n    TSubmitMeta\n  > {\n  onServerValidate: TOnServer\n}\n\nexport const createServerValidate =\n  <\n    TFormData,\n    TOnMount extends undefined | FormValidateOrFn<TFormData>,\n    TOnChange extends undefined | FormValidateOrFn<TFormData>,\n    TOnChangeAsync extends undefined | FormAsyncValidateOrFn<TFormData>,\n    TOnBlur extends undefined | FormValidateOrFn<TFormData>,\n    TOnBlurAsync extends undefined | FormAsyncValidateOrFn<TFormData>,\n    TOnSubmit extends undefined | FormValidateOrFn<TFormData>,\n    TOnSubmitAsync extends undefined | FormAsyncValidateOrFn<TFormData>,\n    TOnDynamic extends undefined | FormValidateOrFn<TFormData>,\n    TOnDynamicAsync extends undefined | FormAsyncValidateOrFn<TFormData>,\n    TOnServer extends undefined | FormAsyncValidateOrFn<TFormData>,\n    TSubmitMeta,\n  >(\n    defaultOpts: CreateServerValidateOptions<\n      TFormData,\n      TOnMount,\n      TOnChange,\n      TOnChangeAsync,\n      TOnBlur,\n      TOnBlurAsync,\n      TOnSubmit,\n      TOnSubmitAsync,\n      TOnDynamic,\n      TOnDynamicAsync,\n      TOnServer,\n      TSubmitMeta\n    >,\n  ) =>\n  async (formData: FormData, info?: Parameters<typeof decode>[1]) => {\n    const { onServerValidate } = defaultOpts\n\n    const runValidator = async ({\n      value,\n      validationSource,\n    }: {\n      value: TFormData\n      validationSource: 'form'\n    }) => {\n      if (isStandardSchemaValidator(onServerValidate)) {\n        return await standardSchemaValidators.validateAsync(\n          { value, validationSource },\n          onServerValidate,\n        )\n      }\n      return (onServerValidate as FormValidateAsyncFn<TFormData>)({\n        value,\n        signal: undefined as never,\n        formApi: undefined as never,\n      })\n    }\n\n    const values = decode(formData, info) as never as TFormData\n\n    const onServerError = (await runValidator({\n      value: values,\n      validationSource: 'form',\n    })) as UnwrapFormAsyncValidateOrFn<TOnServer> | undefined\n\n    if (!onServerError) return values\n\n    const onServerErrorVal = (\n      isGlobalFormValidationError(onServerError)\n        ? onServerError.form\n        : onServerError\n    ) as UnwrapFormAsyncValidateOrFn<TOnServer>\n\n    const formState: ServerFormState<TFormData, TOnServer> = {\n      errorMap: {\n        onServer: onServerError,\n      },\n      values,\n      errors: onServerErrorVal ? [onServerErrorVal] : [],\n    }\n\n    throw new ServerValidateError({\n      formState,\n    })\n  }\n\nexport const initialFormState: ServerFormState<any, undefined> = {\n  errorMap: {\n    onServer: undefined,\n  },\n  values: undefined,\n  errors: [],\n}\n"],"names":["isStandardSchemaValidator","standardSchemaValidators","decode","isGlobalFormValidationError","ServerValidateError"],"mappings":";;;;;AA8CO,MAAM,uBACX,CAcE,gBAeF,OAAO,UAAoB,SAAwC;AACjE,QAAM,EAAE,qBAAqB;AAE7B,QAAM,eAAe,OAAO;AAAA,IAC1B;AAAA,IACA;AAAA,EAAA,MAII;AACJ,QAAIA,SAAAA,0BAA0B,gBAAgB,GAAG;AAC/C,aAAO,MAAMC,SAAAA,yBAAyB;AAAA,QACpC,EAAE,OAAO,iBAAA;AAAA,QACT;AAAA,MAAA;AAAA,IAEJ;AACA,WAAQ,iBAAoD;AAAA,MAC1D;AAAA,MACA,QAAQ;AAAA,MACR,SAAS;AAAA,IAAA,CACV;AAAA,EACH;AAEA,QAAM,SAASC,eAAAA,OAAO,UAAU,IAAI;AAEpC,QAAM,gBAAiB,MAAM,aAAa;AAAA,IACxC,OAAO;AAAA,IACP,kBAAkB;AAAA,EAAA,CACnB;AAED,MAAI,CAAC,cAAe,QAAO;AAE3B,QAAM,mBACJC,SAAAA,4BAA4B,aAAa,IACrC,cAAc,OACd;AAGN,QAAM,YAAmD;AAAA,IACvD,UAAU;AAAA,MACR,UAAU;AAAA,IAAA;AAAA,IAEZ;AAAA,IACA,QAAQ,mBAAmB,CAAC,gBAAgB,IAAI,CAAA;AAAA,EAAC;AAGnD,QAAM,IAAIC,MAAAA,oBAAoB;AAAA,IAC5B;AAAA,EAAA,CACD;AACH;AAEK,MAAM,mBAAoD;AAAA,EAC/D,UAAU;AAAA,IACR,UAAU;AAAA,EAAA;AAAA,EAEZ,QAAQ;AAAA,EACR,QAAQ,CAAA;AACV;;;"}