{"version":3,"file":"createServerValidate.js","sources":["../../../src/start/createServerValidate.tsx"],"sourcesContent":["import {\n  isGlobalFormValidationError,\n  isStandardSchemaValidator,\n  standardSchemaValidators,\n} from '@tanstack/form-core'\nimport { getHeader } from '@tanstack/react-start/server'\nimport { decode } from 'decode-formdata'\nimport { ServerValidateError } from './error'\nimport { setInternalTanStackCookie } from './utils'\nimport type { ServerFormState } from './types'\nimport type {\n  FormAsyncValidateOrFn,\n  FormOptions,\n  FormValidateAsyncFn,\n  FormValidateOrFn,\n  UnwrapFormAsyncValidateOrFn,\n} from '@tanstack/form-core'\n\ninterface CreateServerValidateOptions<\n  TFormData,\n  TOnMount extends undefined | FormValidateOrFn<TFormData>,\n  TOnChange extends undefined | FormValidateOrFn<TFormData>,\n  TOnChangeAsync extends undefined | FormAsyncValidateOrFn<TFormData>,\n  TOnBlur extends undefined | FormValidateOrFn<TFormData>,\n  TOnBlurAsync extends undefined | FormAsyncValidateOrFn<TFormData>,\n  TOnSubmit extends undefined | FormValidateOrFn<TFormData>,\n  TOnSubmitAsync extends undefined | FormAsyncValidateOrFn<TFormData>,\n  TOnDynamic extends undefined | FormValidateOrFn<TFormData>,\n  TOnDynamicAsync extends undefined | FormAsyncValidateOrFn<TFormData>,\n  TOnServer extends undefined | FormAsyncValidateOrFn<TFormData>,\n  TSubmitMeta,\n> extends FormOptions<\n    TFormData,\n    TOnMount,\n    TOnChange,\n    TOnChangeAsync,\n    TOnBlur,\n    TOnBlurAsync,\n    TOnSubmit,\n    TOnSubmitAsync,\n    TOnDynamic,\n    TOnDynamicAsync,\n    TOnServer,\n    TSubmitMeta\n  > {\n  onServerValidate: TOnServer\n}\n\nexport const createServerValidate =\n  <\n    TFormData,\n    TOnMount extends undefined | FormValidateOrFn<TFormData>,\n    TOnChange extends undefined | FormValidateOrFn<TFormData>,\n    TOnChangeAsync extends undefined | FormAsyncValidateOrFn<TFormData>,\n    TOnBlur extends undefined | FormValidateOrFn<TFormData>,\n    TOnBlurAsync extends undefined | FormAsyncValidateOrFn<TFormData>,\n    TOnSubmit extends undefined | FormValidateOrFn<TFormData>,\n    TOnSubmitAsync extends undefined | FormAsyncValidateOrFn<TFormData>,\n    TOnDynamic extends undefined | FormValidateOrFn<TFormData>,\n    TOnDynamicAsync extends undefined | FormAsyncValidateOrFn<TFormData>,\n    TOnServer extends undefined | FormAsyncValidateOrFn<TFormData>,\n    TSubmitMeta,\n  >(\n    defaultOpts: CreateServerValidateOptions<\n      TFormData,\n      TOnMount,\n      TOnChange,\n      TOnChangeAsync,\n      TOnBlur,\n      TOnBlurAsync,\n      TOnSubmit,\n      TOnSubmitAsync,\n      TOnDynamic,\n      TOnDynamicAsync,\n      TOnServer,\n      TSubmitMeta\n    >,\n  ) =>\n  async (formData: FormData, info?: Parameters<typeof decode>[1]) => {\n    const { onServerValidate } = defaultOpts\n\n    const runValidator = async ({\n      value,\n      validationSource,\n    }: {\n      value: TFormData\n      validationSource: 'form'\n    }) => {\n      if (isStandardSchemaValidator(onServerValidate)) {\n        return await standardSchemaValidators.validateAsync(\n          { value, validationSource },\n          onServerValidate,\n        )\n      }\n      return (onServerValidate as FormValidateAsyncFn<TFormData>)({\n        value,\n        signal: undefined as never,\n        formApi: undefined as never,\n      })\n    }\n\n    const referer = getHeader('referer')!\n\n    const data = decode(formData, info) as never as TFormData\n\n    const onServerError = (await runValidator({\n      value: data,\n      validationSource: 'form',\n    })) as UnwrapFormAsyncValidateOrFn<TOnServer> | undefined\n\n    if (!onServerError) return data\n\n    const onServerErrorVal = (\n      isGlobalFormValidationError(onServerError)\n        ? onServerError.form\n        : onServerError\n    ) as UnwrapFormAsyncValidateOrFn<TOnServer>\n\n    const formState: ServerFormState<TFormData, TOnServer> = {\n      errorMap: {\n        onServer: onServerError,\n      },\n      values: data,\n      errors: onServerErrorVal ? [onServerErrorVal] : [],\n    }\n\n    setInternalTanStackCookie(formState)\n\n    throw new ServerValidateError({\n      response: new Response('ok', {\n        headers: {\n          Location: referer,\n        },\n        status: 302,\n      }),\n      formState: formState,\n    })\n  }\n"],"names":[],"mappings":";;;;;AAgDO,MAAM,uBACX,CAcE,gBAeF,OAAO,UAAoB,SAAwC;AACjE,QAAM,EAAE,qBAAqB;AAE7B,QAAM,eAAe,OAAO;AAAA,IAC1B;AAAA,IACA;AAAA,EAAA,MAII;AACJ,QAAI,0BAA0B,gBAAgB,GAAG;AAC/C,aAAO,MAAM,yBAAyB;AAAA,QACpC,EAAE,OAAO,iBAAA;AAAA,QACT;AAAA,MAAA;AAAA,IAEJ;AACA,WAAQ,iBAAoD;AAAA,MAC1D;AAAA,MACA,QAAQ;AAAA,MACR,SAAS;AAAA,IAAA,CACV;AAAA,EACH;AAEA,QAAM,UAAU,UAAU,SAAS;AAEnC,QAAM,OAAO,OAAO,UAAU,IAAI;AAElC,QAAM,gBAAiB,MAAM,aAAa;AAAA,IACxC,OAAO;AAAA,IACP,kBAAkB;AAAA,EAAA,CACnB;AAED,MAAI,CAAC,cAAe,QAAO;AAE3B,QAAM,mBACJ,4BAA4B,aAAa,IACrC,cAAc,OACd;AAGN,QAAM,YAAmD;AAAA,IACvD,UAAU;AAAA,MACR,UAAU;AAAA,IAAA;AAAA,IAEZ,QAAQ;AAAA,IACR,QAAQ,mBAAmB,CAAC,gBAAgB,IAAI,CAAA;AAAA,EAAC;AAGnD,4BAA0B,SAAS;AAEnC,QAAM,IAAI,oBAAoB;AAAA,IAC5B,UAAU,IAAI,SAAS,MAAM;AAAA,MAC3B,SAAS;AAAA,QACP,UAAU;AAAA,MAAA;AAAA,MAEZ,QAAQ;AAAA,IAAA,CACT;AAAA,IACD;AAAA,EAAA,CACD;AACH;"}